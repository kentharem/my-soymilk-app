<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายการสั่งซื้อน้ำเต้าหู้ (ผู้ขาย)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-blue-900 mb-2">รายการสั่งซื้อน้ำเต้าหู้</h1>
        <p class="text-center text-gray-500 mb-6">ข้อมูลอัปเดตจากลูกค้าแบบเรียลไทม์</p>

        <!-- Loading indicator -->
        <div id="loading" class="flex justify-center items-center p-8">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <!-- Order Table -->
        <div id="orderTableContainer" class="hidden">
            <div class="overflow-x-auto relative rounded-lg">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-blue-100">
                        <tr>
                            <th scope="col" class="py-3 px-6 rounded-tl-lg">เวลาสั่งซื้อ</th>
                            <th scope="col" class="py-3 px-6">ชื่อลูกค้า</th>
                            <th scope="col" class="py-3 px-6">เบอร์โทร</th>
                            <!-- 'ที่อยู่' column is intentionally removed as per previous request -->
                            <th scope="col" class="py-3 px-6">เมนู</th>
                            <th scope="col" class="py-3 px-6">ความหวาน</th>
                            <th scope="col" class="py-3 px-6">จำนวน</th>
                            <th scope="col" class="py-3 px-6 rounded-tr-lg">ยอดเงินรวม</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Message Box for error -->
        <div id="messageBox" class="mt-4 p-4 rounded-md hidden">
            <div id="messageText" class="text-center font-medium"></div>
        </div>
    </div>

    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
        (function() {
            // Replace with your Google Apps Script Web app URL
            // IMPORTANT: This URL must be the 'Web app URL' obtained after deploying your Google Apps Script.
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-43mnU9R7SL0BorNNwxqEVlvaJ0A0CVPLcqepGgZ7iv4Gh2pE9iXIyQ_Wr5URCLWAsA/exec'; 

            const orderTableBody = document.getElementById('orderTableBody');
            const orderTableContainer = document.getElementById('orderTableContainer');
            const loadingIndicator = document.getElementById('loading');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            /**
             * Displays a message in the message box.
             * @param {string} message - The message text to display.
             * @param {string} type - The type of message ('error' or 'info').
             */
            function showMessage(message, type) {
                messageBox.classList.remove('hidden');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    messageBox.classList.remove('bg-blue-100', 'text-blue-800'); // Remove info styling if present
                } else { // 'info' or default
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    messageBox.classList.remove('bg-red-100', 'text-red-800'); // Remove error styling if present
                }
                messageText.textContent = message;
            }

            /**
             * Hides the message box.
             */
            function hideMessage() {
                messageBox.classList.add('hidden');
                messageText.textContent = '';
                messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            }

            /**
             * Fetches order data from the Google Apps Script and populates the table.
             */
            async function fetchOrders() {
                try {
                    // Show loading indicator and hide table
                    loadingIndicator.classList.remove('hidden');
                    orderTableContainer.classList.add('hidden');
                    hideMessage(); // Clear any previous messages
                    
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                    const orders = await response.json();
                    
                    // Clear existing table rows before populating new data
                    orderTableBody.innerHTML = '';
                    
                    if (orders.length === 0) {
                        showMessage('ยังไม่มีรายการสั่งซื้อในขณะนี้', 'info');
                        loadingIndicator.classList.add('hidden');
                        return;
                    }

                    // Populate the table with fetched orders
                    orders.forEach(order => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-gray-50';
                        
                        // Format timestamp for display
                        const timestamp = order.Timestamp ? new Date(order.Timestamp).toLocaleString('th-TH', {
                            dateStyle: 'short',
                            timeStyle: 'short'
                        }) : '-';
                        
                        // Display values, using '-' if a field is empty or null
                        // Note: 'Address' field is intentionally not displayed as per previous request.
                        // 'Sweetness' is also not directly used from the main Sweetness column
                        // as it's now embedded in the 'Menu' string for per-item sweetness.
                        row.innerHTML = `
                            <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${timestamp}</td>
                            <td class="py-4 px-6">${order.CustomerName || '-'}</td>
                            <td class="py-4 px-6">${order.PhoneNumber || '-'}</td>
                            <td class="py-4 px-6">${order.Menu || '-'}</td>
                            <td class="py-4 px-6">${order.Sweetness || '-'}</td> 
                            <td class="py-4 px-6">${order.Quantity || '-'}</td>
                            <td class="py-4 px-6">${(order.TotalPrice !== undefined && order.TotalPrice !== null) ? order.TotalPrice.toFixed(2) + ' บาท' : '-'}</td>
                        `;
                        orderTableBody.appendChild(row);
                    });
                    
                    // Hide loading indicator and show the table
                    loadingIndicator.classList.add('hidden');
                    orderTableContainer.classList.remove('hidden');

                } catch (error) {
                    console.error('Error fetching orders:', error);
                    showMessage('เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง', 'error');
                    loadingIndicator.classList.add('hidden');
                }
            }
            
            // Fetch orders when the page loads for the first time
            fetchOrders();
            
            // Refresh orders every 30 seconds to get real-time updates
            setInterval(fetchOrders, 30000); // 30000 milliseconds = 30 seconds
        })();
    </script>
</body>
</html>
